[[Provision-Ansible]]

=== Provisioning Prerequisites
The script and playbooks provided within the git repository deploys
infrastructure, installs and configures OpenShift, and performs post installation
tasks such as scaling the router and registry. The playbooks create specific
roles, policies, and users required for cloud provider configuration in OpenShift, as well as
storage accounts on Azure. In order to deploy OpenShift on Azure, an `ARM` template must be created. The `ARM`
template takes the basic information, admin user name, password, Red Hat Subscription Manager username and password,
`SSH` public and private keys, as well as offering the ability to size the virtual machines.

==== Authentication Prerequisites
The template creates an OpenShift user using the supplied values `adminUsername` and `adminPassword`
in the `ARM` template parameters when creating the infrastructure and it will be granted the `cluster-admin` role for the OpenShift environment.

==== SSH Prerequisites

===== SSH Configuration
The SSH service will be configured during the deployment to allow connections using a public key. To make this work, the same public and private key that were created before will be used for the cloud-user in the instances.
Before beginning the deployment of the Azure infrastructure and the deployment of OpenShift, the SSH
*private key* must be converted into a base64 string. Otherwise, the Azure infrastructure cannot be configured
manually or automatically.

This task is performed locally, on the machine that will run the `ARM` template. In this example,
the private key is converted to base64 encoding, and placed on the clipboard.

* For RHEL/CentOS:

[subs=+quotes]
----
# *cat ~/.ssh/id_rsa | base64 | xclip -selection clipboard*
----

* For OSX:

[subs=+quotes]
----
# *cat ~/.ssh/id_rsa | base64 | pbcopy*
----

* For Windows:
[subs=+quotes]
----
*Use a Base 64 Encoder app or website to perform the conversion*
----

==== Red Hat Subscription Prerequisites
A Red Hat account is required to use this template. This account must have appropriate
subscriptions available in the account in order to use the template. Either a User Name
and Password may be supplied, or a Organization ID and Activation Key.

For the installation of `OCP` on `Azure` one of the following items are required:

[subs=+quotes]
----
Red Hat Subscription Manager User: rhsm-se
Red Hat Subscription Manager Password: SecretPass
Pool ID: 1b152951269116311123bc522341e1
----

The next section will show how to locate the Pool ID.

===== Red Hat Subscription Pool ID
In order to assign a subscription, a Pool ID is required. Using a system that currently has a valid subscription
to Red Hat products, by using subscription-manager the Pool ID can be acquired. Perform the following command, and take
note of the _Pool ID_.

[subs=+quotes]
----
# *subscription-manager list --available*

+-------------------------------------------+
    Available Subscriptions
+-------------------------------------------+
Subscription Name:   Red Hat OpenShift Container Platform, Premium (1-2 Sockets)
Provides:            Red Hat OpenShift Enterprise Application Node
                     Red Hat Software Collections (for RHEL Server)
                     Red Hat Single Sign-On
                     Red Hat Beta
                     dotNET on RHEL Beta (for RHEL Server)
                     Red Hat OpenShift Container Platform
                     JBoss Enterprise Web Server
                     Oracle Java (for RHEL Server)
                     Red Hat OpenShift Enterprise Client Tools
                     Red Hat CloudForms Beta
                     Red Hat Enterprise Linux Server
                     dotNET on RHEL (for RHEL Server)
                     Red Hat Software Collections Beta (for RHEL Server)
                     Red Hat Enterprise Linux Atomic Host
                     Red Hat OpenShift Enterprise Infrastructure
                     Red Hat CloudForms
SKU:                 MCT2862
Contract:            38154141
Pool ID:             1b152951269116311123bc522341e1
Provides Management: No
Available:           64
Suggested:           1
Service Level:       Premium
Service Type:        L1-L3
Subscription Type:   Stackable
Ends:                25/08/2017
System Type:         Physical
----

NOTE: The Pool ID is also available in the https://access.redhat.com/management/subscriptions[*Subscriptions*] section of the Red Hat Customer Portal, by selecting the appropriate subscription that will open a detailed view of the subscription, including the _Pool ID_

==== Organization ID and Activation Key
Instead using user/password combination, an activation key and organization ID can be used.
The activation key is a simple string, chosen by the end-user that contains the subscriptions the user attaches to it to avoid using passwords in the registration procedure.
The organization ID is the Red Hat ID for the customer organizations and it is required when using activation keys to identify the activation keys within the organization.

Perform the following steps to obtain the organization ID and activation key.

===== Generating Activation Key
1. Go to the Red Hat Customer Portal located in http://access.redhat.com and login with your Red Hat username and password. Select "Subscriptions" section in the top left corner then the tab https://access.redhat.com/management/activation_keys["Activation keys"]

2. Create your key selecting the https://access.redhat.com/management/activation_keys/new["New Activation Key"] button

Once in there give your key a name, set service level to standard or premium, and add the subscriptions containing OpenShift.

===== Getting the Organization ID
In order to find the OrgID, a RHEL server is required. Perform the following on a existing RHEL server.

[subs=+quotes]
----
$ subscription-manger identity
----

Find the value labeled org ID: _<orgID>_ and save this somewhere for use during the deployment.

===== Using the Organization ID and Activation Key
When running the ARM Template, use the Organization ID as the RHN User Name, and use the
Activation Key as the RHN Password.

==== Azure Active Directory Credentials
In order to create the `Azure Active Directory` (`AAD`) client id, and password, the nodejs `Azure CLI` package is required.

Follow this instructions to create it in a RHEL/CentOS/Fedora system:

1. Install `nodejs`

[subs=+quotes]
----
$ *sudo yum -y install npm*
----

2. Install the `Azure cli` nodejs package:

[subs=+quotes]
----
$ *sudo npm install -g azure-cli*
----

3. Login to Azure:

[subs=+quotes]
----
$ *azure login*
----

4. Create a service principal:

[subs=+quotes]
----
$ *azure ad sp create -n <service_principle_name> -p <password>*
----

The following is an example output:

[subs=+quotes]
----
$ *azure ad sp create -n openshiftcloudprovider -p Pass@word1*
info:    Executing command ad sp create
+ Creating application openshift demo cloud provider
+ Creating service principal for application 198c4803-1236-4c3f-ad90-46e5f3b4cd2a
data:    Object Id:               00419334-174b-41e8-9b83-9b5011d8d352
data:    Display Name:            openshiftcloudprovider
data:    Service Principal Names:
data:                             198c4803-1236-4c3f-ad90-46e5f3b4cd2a
data:                             http://myhomepage
info:    ad sp create command OK
----

Save the `Object Id` and the `Service Principal Names GUID` values from the command output.

* The `Object Id` will be used to create the role assignment.
* The `Service Principal Names GUID` will be used as the `aadClientId` parameter value (Application ID/Client ID) in the template.
* The password entered as part of the CLI command will be the `aadClientSecret` paramter value in the template.

5. Show the Azure account data:

[subs=+quotes]
----
$ *azure account show*
----

The following is an example output:

[subs=+quotes]
----
$ *azure account show*
info:    Executing command account show
data:    Name                        : Microsoft Azure Sponsorship
data:    ID                          : 2581564b-56b4-4512-a140-012d49dfc02c
data:    State                       : Enabled
data:    Tenant ID                   : 77ece336-c110-470d-a446-757a69cb9485
data:    Is Default                  : true
data:    Environment                 : AzureCloud
data:    Has Certificate             : Yes
data:    Has Access Token            : Yes
data:    User name                   : ssysone@something.com
data:
info:    account show command OK
----

Save the command output `Tenant ID` value that will be used for the provisioning.

6. Grant the service principle the access level of contributor to allow openshift to create/delete resources using the `Object ID` and `Tenant ID` parameters from the previous steps

[subs=+quotes]
----
$ *azure role assignment create --objectId <objectID> -o contributor -c /subscriptions/<tenant_id>/*
----

The following is an example output:

[subs=+quotes]
----
# *azure role assignment create --objectId 00419334-174b-41e8-9b83-9b5011d8d352 -o contributor -c /subscriptions/77ece336-c110-470d-a446-757a69cb9485/*
info:    Executing command role assignment create
+ Finding role with specified name
/data:    RoleAssignmentId     : /subscriptions/2586c64b-38b4-4527-a140-012d49dfc02c/providers/Microsoft.Authorization/roleAssignments/490c9dd5-0bfa-4b4c-bbc0-aa9af130dd06
data:    RoleDefinitionName   : Contributor
data:    RoleDefinitionId     : b24988ac-6180-42a0-ab88-20f7382dd24c
data:    Scope                : /subscriptions/2586c64b-38b4-4527-a140-012d49dfc02c
data:    Display Name         : openshiftcloudprovider
data:    SignInName           : undefined
data:    ObjectId             : 00419334-174b-41e8-9b83-9b5011d8d352
data:    ObjectType           : ServicePrincipal
data:
+
info:    role assignment create command OK
----

=== Introduction to the Azure Template
Azure Resource Manager templates consist of json files. The main template file for this reference architecture is located in the `reference-architecture/azure-ansible/azuredeploy.json` file in the github repository.
This file is the main `ARM` template that launches all the other templates under `azure-ansible`.
There are four types of Virtual Machines created by the template (bastion, master node, infrastructure node and application node) and for each of these types there is a additional json file that defines each VM type.

|====
^|Virtual Machine type ^| Template file

|Bastion| `reference-architecture/azure-ansible/bastion.json`
|Master| `reference-architecture/azure-ansible/master.json`
|Infrastructure node| `reference-architecture/azure-ansible/infranode.json`
|Application node| `reference-architecture/azure-ansible/node.json`
|====

The `ARM` template for each type, automatically starts a bash shell script that does part of the initial setup.
The main shell script is the `reference-architecture/azure-ansible/bastion.sh` that handles the generation
of the ansible host inventory, as well as the setup and running of ansible across all the hosts. The bastion host also provides isolation of all the hosts in the resource group from the public internet for the purpose of SSH access.

=== Provision the OpenShift environment
In order to provision the OpenShift environment using the `ARM` template, the following information is required:

* A Microsoft Azure Subscription, with appropriate core and VM quota limits.
* Resource Group - Used as the name of the OpenShift Cluster - All the assets of a single cluster use the Azure Resource Group to organize and group the assets. This name needs to be unique for each cluster per Azure Region (Location).
* Admin Username and Admin Password - This is an admin user, used for multiple purposes.
   a. As the `SSH` user to be able to connect to the bastion host, and administer the cluster.
   b. As an OpenShift administrative user, able to create and control OpenShift from the command line, or the user interface.
   c. A gmail account, allowing the notification of the installation process of OpenShift.
* SSH Key Data - This is the *public key* (`~/.ssh/id_rsa.pub`), generated for the user that will administer the server. During the creation and installation of OpenShift virtual machines, the key will automatically be added to each host. This assures proper security and access. This key must be backed up, as its the only principal way to access the cluster for administration.
* SSH Private Data - This is the *private key* `~/.ssh/id_rsa` file contents that has been base64 encoded. This data should be backed up.
* Wildcard Zone - DNS subdomain for applications in the OpenShift Cluster.
* Number of Nodes - The template supports the creation of 3 to 30 nodes during greenfield creation of a cluster. Note that the quota of the Azure account must support the number chosen.
* Image - The template supports RHEL (Red Hat Enterprise Linux) 7.3 or later. The image will be upgraded during the installation process to the latest release.
* Master VM Size (default: _Standard_DS4_v2_) - The default value gives 8 CPU Cores, 28 Gigabytes of memory, with 56 GB of premium storage local disk. This is used for OpenShift master nodes, as well as the bastion host.
* Infranode VM Size (default: _Standard_D4_v2_) - The default value gives 8 CPU Cores, 28 Gigabytes of memory, with 56 GB of premium storage local disk. Infrastructure nodes run the OpenShift Router Containers, and the OpenShift Registry. As the infrastructure nodes provide the ingress for all applications, its recommended that _DS2_ be the smallest node used for the infrastructure nodes.
* Node VM Size (default: _Standard_D4_v2_) - The default value gives 8 CPU Cores, 28 Gigabytes of memory, with 56 GB of premium storage local disk. Application nodes is where the application containers run.
* RHN Username - This should be the username used for the Red Hat Subscription Account that has OpenShift Container Platform entitlements, or the _Organization ID_ if using activation keys.
* RHN Password - This should be the password for the Red Hat Subscription Account, or the _activation key_ if using activation keys.
* Subscription Pool ID - This is a number sequence that uniquely identifies the subscriptions that are to be used for the OpenShift installion.
* AAD Client Id - This gives OpenShift the Active Directory ID, needed to be able to create, move and delete persistent volumes.
* AAD Client Secret - The Active Directory Password to match the AAD Client ID. Required for OpenShift Cloud Provider.

With the above information ready, go to https://github.com/openshift/openshift-ansible-contrib/tree/master/reference-architecture/azure-ansible
and click the "Deploy To Azure" button near the bottom of the page. This will then show the form, to allow the deployment to be started.

[arm-template-image]]
.ARM Template
image::images/AzureOCPEmptyTemplate.png["ARM Template",align="center"]

=== Post Ansible Deployment
Once the playbooks have successfully completed the next steps will be to perform the steps defined in <<Operational-Management>>.
In the event that OpenShift failed to install, follow the steps in Appendix C: <<Installation-Failure>> to restart the installation of OpenShift.

// vim: set syntax=asciidoc:
